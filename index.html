<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Advanced Medical Physiology Simulation: GI Macromolecule Digestion">
    <meta name="author" content="Abdullateef Isiaka Alagbonsi, Toyin Mohammed Salman, Shifaau Badmas Assayoti, Abdulkarim Ahmed, Bunmi Aribatise, Kazeem Adewale Gbolagade, Sheu Oluwadare Sulaiman, Fernanda Klein Marcondes">
    <title>Gastrointestinal Digestion of Macromolecules</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Lato:wght@700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            /* 3D WOOD PALETTE */
            --wood-darkest: #1a0f0a; --wood-dark: #3e2723; --wood-medium: #5d4037; --wood-light: #8d6e63;
            --brass: #d4af37;
            /* TILE COLORS */
            --col-1: #3949ab; --col-2: #2e7d32; --col-3: #8e24aa; --col-4: #c62828; --col-5: #00838f;
            /* UI SCALING VARIABLE */
            --ui-scale: 1.0;
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        html { font-size: 16px; }

        body {
            font-family: 'Lato', sans-serif;
            background: #0f0502;
            background-image: radial-gradient(circle at center, #2d1a12 0%, #050201 100%);
            color: #e0d0c0;
            margin: 0; padding: 0;
            height: 100dvh; width: 100vw;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden; user-select: none;
            font-size: calc(1rem * var(--ui-scale));
        }

        /* === SECRET ADMIN TILE === */
        #admin-tile {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%); width: 40px; height: 10px;
            background: var(--brass); border: 1px solid var(--wood-darkest);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5); cursor: pointer; z-index: 10000;
            border-radius: 0 0 10px 10px; opacity: 0.8;
        }
        #admin-tile:hover { opacity: 1; background: #fff; }

        /* === AUTH SCREEN === */
        #auth-screen, #verify-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 5000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(8px); padding: 20px;
        }
        #verify-screen { display: none; }

        .auth-box {
            background: var(--wood-dark); border: 6px solid var(--wood-darkest);
            padding: 25px; border-radius: 12px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto;
        }
        .auth-title { font-family: 'Cinzel', serif; color: var(--brass); font-size: 1.5rem; margin-bottom: 15px; border-bottom: 2px solid var(--brass); padding-bottom: 10px; }
        
        .auth-input, .auth-select { 
            width: 100%; padding: 12px; margin: 6px 0; 
            background: #1a0f0a; border: 1px solid #5d4037; 
            color: var(--brass); font-family: 'Lato', sans-serif; 
            font-size: 1rem; border-radius: 4px; outline: none; 
        }
        .auth-btn { width: 100%; margin-top: 15px; background: var(--brass); color: #1a0f0a; padding: 15px; font-weight: 900; border: none; cursor: pointer; font-family: 'Cinzel', serif; font-size: 1rem; letter-spacing: 1px; box-shadow: 0 5px 0 #8c6b0d; }
        .auth-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #8c6b0d; }
        .auth-toggle { margin-top: 20px; color: #8d6e63; font-size: 0.9rem; cursor: pointer; text-decoration: underline; }
        #signup-fields, #forgot-form { display: none; text-align: left; }
        .section-label { font-size: 0.75rem; color: #8d6e63; text-transform: uppercase; margin-top: 10px; border-bottom: 1px solid #5d4037; display: block; font-weight: bold; }

        /* === HEADER === */
        header {
            width: 100%; padding: 15px 15px 5px 15px; 
            background: var(--wood-dark); border-bottom: 4px solid var(--wood-darkest);
            display: flex; flex-direction: column; gap: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); flex-shrink: 0; z-index: 40;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        h1 { font-family: 'Cinzel', serif; font-size: 1.2rem; margin: 0; color: var(--brass); text-shadow: 0 2px 5px rgba(0,0,0,0.8); text-transform: uppercase; letter-spacing: 1px; }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        #logout-btn { background: transparent; border: 1px solid var(--brass); color: var(--brass); padding: 4px 8px; font-size: 0.7rem; cursor: pointer; font-family: 'Cinzel', serif; font-weight: bold; }
        .zoom-control { display: flex; align-items: center; color: var(--brass); font-family: 'Lato', sans-serif; font-weight: bold; font-size: 0.8rem; }
        input[type=range] { width: 80px; cursor: pointer; margin-left: 5px; accent-color: var(--brass); }
        .metrics-bar { display: flex; justify-content: center; gap: 15px; font-family: 'Cinzel', serif; font-size: 0.75rem; color: #8d6e63; text-transform: uppercase; }
        #display-username { color: #fff; font-weight: bold; }
        #global-passes { color: #4caf50; } #global-fails { color: #f44336; }

        /* === GAME LAYOUT === */
        .game-stage { display: flex; flex-direction: column; width: 100vw; height: 100%; overflow: hidden; flex: 1; }
        
        /* TABLE */
        .table-container { height: 55%; flex: none; background: #fff; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); overflow: auto; position: relative; border-bottom: 4px solid var(--wood-darkest); }
        table { width: 100%; border-collapse: collapse; border-spacing: 0; }
        thead th { position: sticky; top: 0; background: var(--wood-darkest); color: var(--brass); font-family: 'Cinzel', serif; font-size: 0.7rem; font-weight: 900; padding: 5px 1px; text-align: center; border-bottom: 2px solid var(--brass); border-right: 1px solid #5d4037; z-index: 20; }
        td { vertical-align: middle; padding: 0; height: 50px; border: 2px solid #000; color: #000; font-weight: 900; font-size: 0.8rem; position: relative; }
        #table-body td:nth-child(1) { background: #d8bfd8 !important; color: #000 !important; border-right: 2px solid #000 !important; font-family: 'Cinzel', serif; font-size: 0.75rem; font-weight: 900; padding: 2px; width: 80px; max-width: 80px; white-space: normal; line-height: 1.1; word-wrap: break-word; text-align: center; }
        #table-body td:nth-child(2) { background: #ffff00 !important; }
        #table-body td:nth-child(3) { background: #ffccff !important; }
        #table-body td:nth-child(4) { background: #ccffff !important; }
        #table-body td:nth-child(5) { background: #ffff00 !important; }
        #table-body td:nth-child(6) { background: #ccffff !important; }
        
        .drop-zone { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .drop-zone.hover-target { background-color: rgba(255, 255, 255, 0.6); box-shadow: inset 0 0 0 3px #000; }

        /* INVENTORY */
        .inventory { flex: 1; background: #1b3c24; border-top: 4px solid var(--wood-darkest); width: 100vw; display: flex; flex-direction: column; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); z-index: 30; }
        .inventory-header { background: var(--wood-darkest); color: var(--brass); padding: 4px; text-align: center; font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.85rem; border-bottom: 2px solid var(--brass); }
        .inventory-pool { flex: 1; padding: 5px; overflow-y: auto; background-color: #1b3c24; display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); grid-auto-rows: 50px; gap: 2px; align-content: start; }

        /* TILES */
        .chip { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 2px; text-align: center; font-size: 0.7rem; font-weight: 900; cursor: grab; color: #fff; text-shadow: 0 1px 1px rgba(0,0,0,0.8); box-shadow: inset 1px 1px 0 rgba(255,255,255,0.2); word-break: break-word; line-height: 1.1; touch-action: none; }
        .col-1 { background-color: #3949ab; } .col-2 { background-color: #2e7d32; } .col-3 { background-color: #8e24aa; } .col-4 { background-color: #c62828; } .col-5 { background-color: #00838f; }
        .drop-zone .chip { background: transparent !important; color: #000 !important; text-shadow: none !important; box-shadow: none !important; font-size: 0.8rem; }
        .drag-clone { position: fixed; pointer-events: none; z-index: 9999; width: 90px; height: 50px; background: #8d6e63; color: #fff; border: 2px solid var(--brass); display: flex; justify-content: center; align-items: center; text-align: center; font-weight: 900; font-size: 0.8rem; opacity: 0.9; }

        /* CONTROLS */
        .controls-area { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(26, 15, 10, 0.95); padding: 5px 15px; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid var(--brass); z-index: 100; }
        .btn-group { display: flex; gap: 10px; }
        .btn { border: none; padding: 8px 12px; border-radius: 4px; font-family: 'Cinzel', serif; font-weight: 700; cursor: pointer; font-size: 0.8rem; color: #fff; background: var(--wood-dark); border: 1px solid #5d4037; }
        .btn-reset { background: #8a2323; }
        #check-btn { background: var(--brass); color: #24140e; padding: 8px 20px; font-size: 1rem; font-weight: 900; letter-spacing: 1px; border: 1px solid #ffe57f; box-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
        #check-btn:disabled { background: #5d4037; color: #3e2723; border: 1px solid #3e2723; box-shadow: none; }

        /* DESKTOP LAYOUT */
        @media (min-width: 1024px) {
            .game-stage { flex-direction: row; padding: 20px; }
            .table-container { flex: 2; height: auto; margin-right: 15px; border: 4px solid var(--wood-darkest); }
            .inventory { flex: 1; border: 4px solid var(--wood-darkest); width: auto; background: var(--wood-dark); height: auto; }
            .controls-area { position: absolute; bottom: 40px; right: 40px; width: auto; background: transparent; border: none; }
            td { height: 70px; font-size: 0.9rem; } .chip { font-size: 0.9rem; } .drag-clone { width: 110px; height: 70px; font-size: 0.95rem; } h1 { font-size: 1.8rem; }
        }
        footer { width: 100%; text-align: center; padding: 5px; color: #8d6e63; font-size: 0.6rem; font-family: 'Cinzel', serif; background: #0f0502; padding-bottom: 60px; }
        @media (min-width: 1024px) { footer { padding-bottom: 10px; } }

        /* === REPORT MODAL (NEW) === */
        .report-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 6000; justify-content: center; align-items: center; }
        .report-card { background: #f5f5f5; color: #000; width: 95%; max-width: 900px; max-height: 90vh; border: 8px solid var(--wood-dark); box-shadow: 0 0 100px #000; display: flex; flex-direction: column; position: relative; }
        .report-header { background: var(--wood-darkest); color: var(--brass); padding: 25px; text-align: center; font-family: 'Cinzel', serif; font-size: 1.5rem; border-bottom: 5px solid var(--brass); font-weight: 900; }
        .report-content { padding: 20px; overflow-y: auto; position: relative; }
        
        .user-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #ccc; font-size: 0.95rem; }
        
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .report-table th { background: #ddd; padding: 10px; text-align: left; font-family: 'Cinzel', serif; border-bottom: 2px solid #000; font-size: 0.9rem; color: #000; }
        .report-table td { padding: 10px; border-bottom: 1px solid #ccc; font-size: 0.9rem; color: #000; border: none; height: auto; font-weight: normal; }
        
        .status-pass { color: #2e7d32; font-weight: 900; } .status-fail { color: #c62828; font-weight: 900; }
        .watermark-text { margin-top: 20px; text-align: center; color: #555; font-size: 0.8rem; font-weight: bold; font-family: 'Cinzel', serif; padding: 10px; border-top: 2px solid #ccc; }
        .btn-group-center { display: flex; gap: 10px; justify-content: center; }

        /* PRINT STYLES */
        @media print {
            body * { visibility: hidden; }
            .report-modal, .report-modal * { visibility: visible; }
            .report-modal { position: absolute; left: 0; top: 0; background: white; width: 100%; height: 100%; display: block !important; }
            .report-card { border: 2px solid #000; box-shadow: none; width: 100%; max-width: 100%; height: auto; max-height: none; }
            .auth-btn, .action-btn { display: none !important; }
            #confetti { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="admin-tile" onclick="exportToExcel()"></div>

    <div id="auth-screen">
        <div class="auth-box">
            <div class="auth-title">Physiology Access</div>
            <div id="login-form">
                <input type="email" id="email" class="auth-input" placeholder="Email Address">
                <input type="password" id="password" class="auth-input" placeholder="Password">
                <button class="auth-btn" onclick="handleAuth()">ENTER LAB</button>
                <div style="margin-top:15px; text-align:right;">
                    <span style="color:#8d6e63; cursor:pointer; font-size:0.9rem; text-decoration:underline;" onclick="toggleForgotMode()">Forgot Password?</span>
                </div>
            </div>
            <div id="forgot-form">
                <p style="color:#e0d0c0; font-size:0.9rem; margin-bottom:15px;">Enter your email to reset password.</p>
                <input type="email" id="forgot-email" class="auth-input" placeholder="Enter Email">
                <button class="auth-btn" onclick="resetPassword()">SEND LINK</button>
                <div class="auth-toggle" onclick="toggleForgotMode()">Back to Login</div>
            </div>
            <div id="signup-fields">
                <span class="section-label">Researcher Details</span>
                <input type="email" id="signup-email" class="auth-input" placeholder="Email Address">
                <input type="password" id="signup-password" class="auth-input" placeholder="Create Password">
                <input type="text" id="fullName" class="auth-input" placeholder="Full Name">
                <input type="text" id="institution" class="auth-input" placeholder="Institution">
                <input type="text" id="course" class="auth-input" placeholder="Course/Department">
                <select id="level" class="auth-select">
                    <option value="" disabled selected>Select Level</option>
                    <option value="Undergraduate">Undergraduate</option>
                    <option value="Postgraduate">Postgraduate</option>
                    <option value="Faculty">Faculty</option>
                </select>
                <select id="role" class="auth-select">
                    <option value="" disabled selected>Select Role</option>
                    <option value="Student">Student</option>
                    <option value="Tutor">Tutor</option>
                </select>
                <input type="text" id="country" class="auth-input" placeholder="Country">
                <button class="auth-btn" onclick="handleAuth()">REGISTER NEW ID</button>
            </div>
            <div id="main-toggle" class="auth-toggle" onclick="toggleAuthMode()">New Researcher? Sign Up here</div>
            <p id="auth-error" style="color:red; margin-top:10px; font-size:0.8rem;"></p>
            <p style="color:#8d6e63; font-style:italic; font-size:0.8rem; margin-top:15px; border-top:1px solid #3e2723; padding-top:10px;">
                <span style="color:#d4af37;">ðŸ’¡ Tip:</span> For the best experience, please play on a <strong>Laptop or PC</strong>.
            </p>
        </div>
    </div>

    <div id="verify-screen">
        <div class="auth-box">
            <div class="auth-title">Verification Required</div>
            <p style="color:#e0d0c0; margin-bottom:20px;">Check your email inbox (and spam).</p>
            <button class="auth-btn" onclick="checkVerification()">I HAVE VERIFIED</button>
            <div class="auth-toggle" onclick="resendVerification()">Resend Link</div>
            <div class="auth-toggle" onclick="location.reload()">Back to Login</div>
        </div>
    </div>

    <header>
        <div class="header-top">
            <h1>Gastrointestinal Digestion</h1>
            <div class="header-controls">
                <span id="display-username" style="color:#d4af37; font-size:0.8rem; font-weight:bold;">Guest</span>
                <button id="logout-btn" onclick="handleLogout()">LOGOUT</button>
                <div class="zoom-control">
                    ZOOM: <span style="font-size:1.5rem; margin-right:5px;">-</span>
                    <input type="range" min="12" max="22" step="1" value="16" oninput="document.documentElement.style.fontSize = this.value + 'px'" title="Adjust Zoom">
                    <span style="font-size:1.5rem;">+</span>
                </div>
            </div>
        </div>
        <div class="metrics-bar">
            <div class="metric-item">Researchers: <span id="global-players">...</span></div>
            <div class="metric-item">Passes: <span id="global-passes">0</span></div>
            <div class="metric-item">Fails: <span id="global-fails">0</span></div>
        </div>
    </header>

    <div class="game-stage">
        <div class="table-container">
            <table id="game-table">
                <thead>
                    <tr>
                        <th style="width: 15%">Enzyme</th>
                        <th style="width: 17%">Source</th>
                        <th style="width: 17%">Class</th>
                        <th style="width: 17%">Substrate</th>
                        <th style="width: 17%">Major site</th>
                        <th style="width: 17%">End product</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        <div class="inventory">
            <div class="inventory-header">Fragment Repository</div>
            <div class="inventory-pool" id="pool"></div>
        </div>
    </div>

    <div class="controls-area">
        <div class="btn-group">
            <button class="btn btn-undo" onclick="undoLastMove()">Undo</button>
            <button class="btn btn-reset" onclick="confirmReset()">Reset</button>
        </div>
        <button id="check-btn" onclick="checkAnswers()" disabled>CHECK</button>
    </div>

    <footer>
        &copy; 2025 Alagbonsi, A. I., Salman, T. M., Dada, M. O., Okedun, E. S., Ajibola, A. A., Adepoju, A. A., Gbolagade, K. A., & Marcondes, F. K.
    </footer>

    <div id="report-modal" class="report-modal">
        <div class="report-card">
            <div class="report-header">DIGESTION GAME RESULT</div>
            <div class="report-content">
                <div class="user-details-grid" id="report-user-details"></div>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th style="width:40%">Enzyme</th>
                            <th style="width:30%">Status</th>
                            <th style="width:30%">Score (Max 5)</th>
                        </tr>
                    </thead>
                    <tbody id="report-body"></tbody>
                </table>
                <div id="final-verdict" style="text-align:center; font-weight:900; font-size:1.6rem; margin:20px 0; padding:15px; border:3px solid #000; text-transform:uppercase;"></div>
                <div id="quote-area" style="text-align:center; color:#555; font-style:italic; margin-bottom:20px; font-weight:bold; font-size:1.1rem;"></div>
                
                <div class="btn-group-center">
                    <button class="auth-btn" style="background:#5d4037; color:#fff;" onclick="window.print()">DOWNLOAD RESULT</button>
                    <button class="auth-btn" onclick="resetGameSession()">NEW SESSION</button>
                </div>
                
                <div class="watermark-text">
                    &copy; 2025 Alagbonsi, A. I., Salman, T. M., Dada, M. O., Okedun, E. S., Ajibola, A. A., Adepoju, A. A., Gbolagade, K. A., & Marcondes, F. K.
                </div>
            </div>
        </div>
        <canvas id="confetti" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"></canvas>
    </div>

    <script>
        // ==========================================
        //  FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA2zQtQ5KiQDlxEtLun5xeHt361g_l4jro",
            authDomain: "physiopuzzle-af7d0.firebaseapp.com",
            projectId: "physiopuzzle-af7d0",
            storageBucket: "physiopuzzle-af7d0.firebasestorage.app",
            messagingSenderId: "627635975940",
            appId: "1:627635975940:web:e3704ddc88b077a6bd0251",
            measurementId: "G-HY664SZJZG"
        };

        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- AUTH & VERIFICATION ---
        let isSignUp = false; let isForgotMode = false; let currentUser = null; let userProfile = null;

        function toggleAuthMode() {
            if(isForgotMode) return;
            isSignUp = !isSignUp;
            document.getElementById('login-form').style.display = isSignUp ? 'none' : 'block';
            document.getElementById('signup-fields').style.display = isSignUp ? 'block' : 'none';
            document.getElementById('main-toggle').innerText = isSignUp ? "Already have an ID? Login" : "New Researcher? Sign Up here";
        }

        function toggleForgotMode() {
            isForgotMode = !isForgotMode;
            document.getElementById('login-form').style.display = isForgotMode ? 'none' : 'block';
            document.getElementById('signup-fields').style.display = 'none';
            document.getElementById('forgot-form').style.display = isForgotMode ? 'block' : 'none';
            document.getElementById('main-toggle').style.display = isForgotMode ? 'none' : 'block';
        }

        function resetPassword() {
            const email = document.getElementById('forgot-email').value;
            if(!email) { alert("Enter email."); return; }
            auth.sendPasswordResetEmail(email).then(() => { alert("Check your email!"); toggleForgotMode(); }).catch(e => alert(e.message));
        }

        function handleLogout() {
            if(confirm("Sign out?")) auth.signOut().then(() => location.reload());
        }

        function handleAuth() {
            const errorMsg = document.getElementById('auth-error'); errorMsg.innerText = "";
            if(isSignUp) {
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const fullName = document.getElementById('fullName').value;
                const institution = document.getElementById('institution').value;
                const course = document.getElementById('course').value;
                const level = document.getElementById('level').value;
                const role = document.getElementById('role').value;
                const country = document.getElementById('country').value;

                if(!email || !password || !fullName || !institution || !country) { errorMsg.innerText = "Fill all fields."; return; }

                auth.createUserWithEmailAndPassword(email, password).then(cred => {
                    cred.user.sendEmailVerification();
                    const profile = { email, fullName, institution, course, level, role, country, attempts: 0, personalWins: 0, personalFails: 0, joined: new Date() };
                    db.collection('users').doc(cred.user.uid).set(profile);
                    userProfile = profile;
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('verify-screen').style.display = 'flex';
                }).catch(e => errorMsg.innerText = e.message);
            } else {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                auth.signInWithEmailAndPassword(email, password).then(cred => {
                    if(!cred.user.emailVerified) {
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('verify-screen').style.display = 'flex';
                    }
                }).catch(e => errorMsg.innerText = e.message);
            }
        }

        function checkVerification() {
            auth.currentUser.reload().then(() => { if (auth.currentUser.emailVerified) location.reload(); else alert("Email not verified yet."); });
        }
        function resendVerification() { auth.currentUser.sendEmailVerification().then(() => alert("Sent!")); }

        auth.onAuthStateChanged(user => {
            if(user && user.emailVerified) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('verify-screen').style.display = 'none';
                db.collection('users').doc(user.uid).get().then(doc => {
                    if(doc.exists) {
                        userProfile = doc.data();
                        document.getElementById('display-username').innerText = `Welcome, ${userProfile.fullName} (${userProfile.institution})`;
                    }
                });
                loadStats(); initGame(); SoundManager.init();
            }
        });

        function loadStats() {
            db.collection('users').onSnapshot(snapshot => {
                let totalResearchers = snapshot.size; let totalPasses = 0; let totalFails = 0;
                snapshot.forEach(doc => { const data = doc.data(); totalPasses += (data.personalWins || 0); totalFails += (data.personalFails || 0); });
                document.getElementById('global-players').innerText = totalResearchers;
                document.getElementById('global-passes').innerText = totalPasses;
                document.getElementById('global-fails').innerText = totalFails;
            });
        }

        // --- GAME LOGIC ---
        const SoundManager = {
            ctx: null,
            init: function() { window.AudioContext = window.AudioContext || window.webkitAudioContext; this.ctx = new AudioContext(); },
            playTone: function(freq, type, duration, vol=0.1) {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },
            click: function() { this.playTone(800, 'sine', 0.05, 0.05); },
            drop: function() { this.playTone(200, 'triangle', 0.1, 0.1); },
            error: function() { if (!this.ctx) this.init(); const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, this.ctx.currentTime); gain.gain.setValueAtTime(0.2, this.ctx.currentTime); gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.5); osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(this.ctx.currentTime + 0.5); },
            win: function() { [440, 554, 659, 880].forEach((f, i) => setTimeout(() => this.playTone(f, 'sine', 0.3, 0.1), i*100)); },
            fanfare: function() { const notes = [523, 523, 523, 659, 783, 783, 659, 783, 1046]; let time = 0; notes.forEach(note => { setTimeout(() => this.playTone(note, 'square', 0.2, 0.1), time); time += 150; }); }
        };

        const enzymeData = [
            { name: "Salivary amylase", source: "Salivary glands", class: "Carbohydrase", substrate: "Î±-1,4 glycosidic bond", site: "Mouth", product: "Maltose, maltotriose, Î±-limit dextrins" },
            { name: "Pancreatic amylase", source: "Pancreas", class: "Carbohydrase", substrate: "Î±-1,4 glycosidic bond", site: "Duodenum", product: "Maltose, maltotriose, Î±-limit dextrins" },
            { name: "Isomaltase", source: "Enterocytes", class: "Î±-limit dextrinase", substrate: "Î±-1,6 glycosidic bond", site: "Small intestine", product: "Glucose" },
            { name: "Sucrase", source: "Enterocytes", class: "Disaccharidase", substrate: "Sucrose", site: "Jejunum", product: "Glucose + fructose" },
            { name: "Lactase", source: "Enterocytes", class: "Disaccharidase", substrate: "Lactose", site: "Jejunum", product: "Glucose + galactose" },
            { name: "Maltase", source: "Enterocytes", class: "Disaccharidase", substrate: "Maltose", site: "Jejunum", product: "Glucose" },
            { name: "Lingual lipase", source: "Tongue glands", class: "Lipase", substrate: "Triglycerides", site: "Mouth and stomach", product: "Free fatty acids + diglycerides" },
            { name: "Gastric lipase", source: "Stomach", class: "Lipase", substrate: "Triglycerides", site: "Stomach", product: "Free fatty acids + diglycerides" },
            { name: "Pancreatic lipase", source: "Pancreas", class: "Lipase", substrate: "Triglycerides", site: "Duodenum", product: "Free fatty acids + monoglycerides" },
            { name: "Phospholipase", source: "Pancreas", class: "Lipase", substrate: "Phospholipids", site: "Duodenum", product: "Fatty acids + lysophospholipids" },
            { name: "Pepsin", source: "Stomach (chief cells)", class: "Endopeptidase", substrate: "Proteins", site: "Stomach", product: "Peptides" },
            { name: "Trypsin", source: "Pancreas", class: "Endopeptidase", substrate: "Internal peptide bonds", site: "Duodenum", product: "Peptides" },
            { name: "Chymotrypsin", source: "Pancreas", class: "Endopeptidase", substrate: "Internal peptide bonds", site: "Duodenum", product: "Peptides" },
            { name: "Elastase", source: "Pancreas", class: "Endopeptidase", substrate: "Internal peptide bonds", site: "Duodenum", product: "Peptides" },
            { name: "Carboxypeptidase", source: "Pancreas", class: "Exopeptidase", substrate: "Peptide ends", site: "Duodenum", product: "Amino acids" },
            { name: "Aminopeptidase", source: "Small intestine", class: "Exopeptidase", substrate: "Peptide ends", site: "Duodenum", product: "Amino acids" }
        ];

        const palette = ['col-1', 'col-2', 'col-3', 'col-4', 'col-5'];
        const tableBody = document.getElementById('table-body');
        const pool = document.getElementById('pool');
        const checkBtn = document.getElementById('check-btn');
        let historyStack = []; let draggedItem = null; let originalParent = null; let dragClone = null; let keysPressed = {};

        function initGame() {
            tableBody.innerHTML = ''; pool.innerHTML = ''; historyStack = []; checkBtn.disabled = true; let draggables = [];
            enzymeData.forEach((row, index) => {
                const tr = document.createElement('tr'); tr.id = `row-${index}`;
                const tdName = document.createElement('td'); tdName.className = 'enzyme-name'; tdName.innerHTML = row.name; tr.appendChild(tdName);
                ['source', 'class', 'substrate', 'site', 'product'].forEach(prop => {
                    const td = document.createElement('td');
                    const dropZone = document.createElement('div'); dropZone.className = 'drop-zone'; dropZone.id = `zone-${index}-${prop}`; dropZone.setAttribute('data-correct', row[prop]);
                    td.appendChild(dropZone); tr.appendChild(td);
                    draggables.push({ id: `tile-${index}-${prop}`, text: row[prop] });
                });
                tableBody.appendChild(tr);
            });
            shuffleArray(draggables);
            draggables.forEach(item => pool.appendChild(createChip(item.id, item.text)));
            window.addEventListener('keydown', handleKeyDown); window.addEventListener('keyup', handleKeyUp);
            document.body.addEventListener('click', () => { if(!SoundManager.ctx) SoundManager.init(); }, {once:true});
        }

        function createChip(id, text) {
            const chip = document.createElement('div'); chip.className = 'chip ' + palette[Math.floor(Math.random() * palette.length)]; chip.id = id; chip.innerHTML = text;
            chip.addEventListener('pointerdown', handlePointerDown); return chip;
        }

        function handleKeyDown(e) {
            keysPressed[e.key.toLowerCase()] = true;
            if (keysPressed['a'] && keysPressed['b'] && keysPressed['c']) { autoSolve(); }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') { e.preventDefault(); undoLastMove(); }
        }
        function handleKeyUp(e) { keysPressed[e.key.toLowerCase()] = false; }
        function autoSolve() { SoundManager.win(); enzymeData.forEach((row, rowIndex) => { ['source', 'class', 'substrate', 'site', 'product'].forEach(prop => { const tile = document.getElementById(`tile-${rowIndex}-${prop}`); const zone = document.getElementById(`zone-${rowIndex}-${prop}`); if (tile && zone) zone.appendChild(tile); }); }); updateState(); }

        function handlePointerDown(e) { e.preventDefault(); SoundManager.click(); draggedItem = e.target; originalParent = draggedItem.parentElement; dragClone = document.createElement('div'); dragClone.className = draggedItem.className + ' drag-clone'; dragClone.innerHTML = draggedItem.innerHTML; document.body.appendChild(dragClone); draggedItem.style.opacity = '0.2'; moveClone(e.clientX, e.clientY); document.addEventListener('pointermove', handlePointerMove); document.addEventListener('pointerup', handlePointerUp); }
        function handlePointerMove(e) { e.preventDefault(); moveClone(e.clientX, e.clientY); document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('hover-target')); const el = document.elementFromPoint(e.clientX, e.clientY); if (!el) return; const zone = el.closest('.drop-zone'); if (zone) zone.classList.add('hover-target'); }
        function handlePointerUp(e) { document.removeEventListener('pointermove', handlePointerMove); document.removeEventListener('pointerup', handlePointerUp); if (dragClone) { dragClone.remove(); dragClone = null; } draggedItem.style.opacity = '1'; const el = document.elementFromPoint(e.clientX, e.clientY); let targetZone = el ? el.closest('.drop-zone') : null; let targetPool = el ? el.closest('.inventory-pool') : null; if (targetZone) { if (targetZone.children.length > 0) pool.appendChild(targetZone.children[0]); targetZone.appendChild(draggedItem); historyStack.push({ el: draggedItem, oldP: originalParent, newP: targetZone }); SoundManager.drop(); } else if (targetPool) { pool.appendChild(draggedItem); historyStack.push({ el: draggedItem, oldP: originalParent, newP: pool }); SoundManager.drop(); } document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('hover-target')); updateState(); }
        function moveClone(x, y) { if (dragClone) { dragClone.style.left = (x - 40) + 'px'; dragClone.style.top = (y - 40) + 'px'; } }
        function updateState() { document.querySelectorAll('.drop-zone').forEach(z => { z.classList.toggle('lit', z.children.length > 0); }); const zones = document.querySelectorAll('.drop-zone'); const filled = Array.from(zones).filter(z => z.children.length > 0).length; checkBtn.disabled = (filled !== zones.length); }
        function undoLastMove() { if (historyStack.length === 0) return; SoundManager.click(); const last = historyStack.pop(); if(last.oldP.classList.contains('drop-zone') && last.oldP.children.length > 0) pool.appendChild(last.oldP.children[0]); last.oldP.appendChild(last.el); updateState(); }
        function confirmReset() { if(confirm("Reset Protocol?")) initGame(); }
        function resetGameSession() { document.getElementById('report-modal').style.display = 'none'; initGame(); }

        // --- CORE CHECK LOGIC & REPORT GENERATION ---
        function checkAnswers() {
            const rows = document.querySelectorAll('#table-body tr'); 
            let totalRows = rows.length;
            let rowsPassed = 0;
            let reportHTML = "";
            let overallPass = true;

            // 1. Populate User Details
            if (userProfile) {
                document.getElementById('report-user-details').innerHTML = `
                    <div><strong>Name:</strong> ${userProfile.fullName}</div>
                    <div><strong>Institution:</strong> ${userProfile.institution}</div>
                    <div><strong>Dept:</strong> ${userProfile.course}</div>
                    <div><strong>Country:</strong> ${userProfile.country}</div>
                `;
            }

            // 2. Grade Each Row
            rows.forEach((row, index) => {
                const enzymeName = enzymeData[index].name;
                const zones = row.querySelectorAll('.drop-zone');
                let correctCount = 0;
                
                zones.forEach(z => {
                    if (z.children.length > 0 && z.children[0].innerHTML === z.getAttribute('data-correct')) {
                        correctCount++;
                    }
                });

                const isRowPass = (correctCount === 5);
                if (isRowPass) rowsPassed++;
                else overallPass = false;

                reportHTML += `
                    <tr>
                        <td>${enzymeName}</td>
                        <td class="${isRowPass ? 'status-pass' : 'status-fail'}">${isRowPass ? 'PASSED' : 'FAILED'}</td>
                        <td>${correctCount} / 5</td>
                    </tr>
                `;
            });

            document.getElementById('report-body').innerHTML = reportHTML;

            const verdict = document.getElementById('final-verdict');
            const quote = document.getElementById('quote-area');

            if (overallPass) {
                verdict.innerText = "GAME PASSED";
                verdict.style.color = "#2e7d32"; verdict.style.borderColor = "#2e7d32";
                quote.innerText = '"Science is the captain, and practice the soldiers." â€” Leonardo da Vinci';
                SoundManager.fanfare(); startCelebration();
            } else {
                verdict.innerText = "GAME FAILED";
                verdict.style.color = "#c62828"; verdict.style.borderColor = "#c62828";
                quote.innerText = "Precision is key. Review the failed pathways.";
                SoundManager.error();
            }

            // 3. Save to Firebase
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({
                    lastAttempt: new Date(),
                    status: overallPass ? "PASSED" : "Failed",
                    attempts: firebase.firestore.FieldValue.increment(1),
                    personalFails: firebase.firestore.FieldValue.increment(overallPass ? 0 : 1),
                    personalWins: firebase.firestore.FieldValue.increment(overallPass ? 1 : 0)
                }, { merge: true });
            }

            document.getElementById('report-modal').style.display = 'flex';
        }

        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
        function startCelebration() { const c = document.getElementById('confetti'); const ctx = c.getContext('2d'); c.width = window.innerWidth; c.height = window.innerHeight; const colors = ['#00FFFF', '#FF00FF', '#FFFF00', '#00FF00', '#FFA500', '#FFFFFF']; let particles = []; for(let i=0; i<150; i++) particles.push({x: Math.random()*c.width, y: Math.random()*c.height - c.height, c: colors[Math.floor(Math.random()*colors.length)], s: Math.random()*10+5, d: Math.random()*5+2, r: Math.random()*0.2-0.1}); let fireworks = []; function fire() { const x = Math.random()*c.width; const y = Math.random()*(c.height/2); const col = colors[Math.floor(Math.random()*colors.length)]; for(let i=0; i<3; i++) fireworks.push({x:x, y:y, vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:1, c:col}); } setInterval(fire, 800); function draw() { ctx.clearRect(0,0,c.width,c.height); particles.forEach(p => { ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.r); ctx.fillStyle = p.c; ctx.fillRect(0,0,p.s, p.s*0.4); ctx.restore(); p.y += p.d; p.x += Math.sin(p.y*0.05); if(p.y > c.height) p.y = -10; }); for(let i=fireworks.length-1; i>=0; i--) { let f = fireworks[i]; ctx.beginPath(); ctx.arc(f.x, f.y, 3, 0, Math.PI*2); ctx.fillStyle = f.c; ctx.globalAlpha = f.life; ctx.fill(); f.x += f.vx; f.y += f.vy; f.vy += 0.1; f.life -= 0.02; if(f.life <= 0) fireworks.splice(i,1); } ctx.globalAlpha = 1.0; requestAnimationFrame(draw); } draw(); }

        // ==========================================
        //  SECRET ADMIN EXPORT TOOL
        // ==========================================
        async function exportToExcel() {
            const password = prompt("Enter Admin Password to Download Data:");
            if (password !== "alagbonsi123") { alert("Access Denied."); return; }
            alert("Generating Spreadsheet... Please wait.");
            try {
                const snapshot = await db.collection('users').get();
                let csvContent = "data:text/csv;charset=utf-8,Name,Email,Institution,Course,Level,Role,Country,Attempts,Wins,Fails,LastStatus\n";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const clean = (text) => (text || "").toString().replace(/,/g, " ");
                    let row = [
                        clean(data.fullName), clean(data.email), clean(data.institution), clean(data.course),
                        clean(data.level), clean(data.role), clean(data.country),
                        data.attempts || 0, data.personalWins || 0, data.personalFails || 0, clean(data.status || "In Progress")
                    ];
                    csvContent += row.join(",") + "\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "Physiology_Game_Results.csv");
                document.body.appendChild(link); link.click();
            } catch (error) { console.error(error); alert("Error exporting data."); }
        }
    </script>
</body>
</html>